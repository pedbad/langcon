{# src/core/templates/core/partials/navbar.html #}
{% load navigation icons user_roles %}

{#
  Navbar (Tailwind v4 + Cotton/ShadCN)
  - Consistent .nav-link styling (light/dark)
  - Uses active_url / aria_current templatetags (no resolver_match access)
  - Mobile panel respects reduced motion via .transition-standard
#}

<nav
  x-data="{ open: false }"
  aria-label="Primary navigation"
  class="text-foreground"
>
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">

    {# LEFT: logo + desktop nav #}
    <div class="flex items-center gap-4">
      {% include "core/partials/logo.html" %}

      {# DESKTOP NAV (≥ sm) #}
      <div class="hidden sm:flex items-center gap-6 ml-6">

        {# Public: Home #}
        <a
          href="{% url 'core:landing' %}"
          class="nav-link focus-ring rounded-md px-2 py-1.5 {% active_url 'core:landing' %}"
          {% aria_current 'core:landing' %}
        >
          {% icon 'home' class_='h-5 w-5 align-middle shrink-0' %}
          <span>Home</span>
        </a>

        {# Public: About (treat /about/* as active) #}
        <a
          href="{% url 'core:about' %}"
          class="nav-link focus-ring rounded-md px-2 py-1.5 {% active_url 'core:about' startswith='/about/' %}"
          {% aria_current 'core:about' startswith='/about/' %}
        >
          {% icon 'info' class_='h-5 w-5 align-middle shrink-0' %}
          <span>About</span>
        </a>

        {% if request.user.is_authenticated %}

          {# Dashboard (multi-role) #}
          {% aria_current 'users:student_home' 'users:teacher_home' 'users:admin_home' as current_attr %}
          <a
            {% if request.user|is_teacher %}
              href="{% url 'users:teacher_home' %}"
            {% elif request.user|is_admin %}
              href="{% url 'users:admin_home' %}"
            {% else %}
              href="{% url 'users:student_home' %}"
            {% endif %}
            class="nav-link focus-ring flex w-full rounded-md px-3 py-2 {% active_url 'users:student_home' 'users:teacher_home' 'users:admin_home' %}"
            {{ current_attr }}
          >
            {% icon 'dashboard' class_='h-5 w-5 align-middle shrink-0' %}
            <span>Dashboard</span>
          </a>

          {# Staff-only: Admin #}
          {% if request.user.is_staff %}
            <a
              href="/admin/"
              class="nav-link focus-ring rounded-md px-2 py-1.5 {% active_url startswith='/admin/' %}"
              {% aria_current startswith='/admin/' %}
            >
              {% icon 'admin' class_='h-5 w-5 align-middle shrink-0' %}
              <span>Admin</span>
            </a>
          {% endif %}

          {# Admin-only: Register #}
          {% if request.user|is_admin %}
            <a
              href="{% url 'users:register' %}"
              class="nav-link focus-ring rounded-md px-2 py-1.5 {% active_url 'users:register' startswith='/users/register' %}"
              {% aria_current 'users:register' startswith='/users/register' %}
            >
              {% icon 'user_plus' class_='h-5 w-5 align-middle shrink-0' %}
              <span>Register</span>
            </a>
          {% endif %}

          {# Role placeholders (optional) #}
          {% if request.user|is_student %}
            <a href="#" class="nav-link">
              {% icon 'school' class_='h-5 w-5 align-middle shrink-0' %}
              <span>Courses</span>
            </a>
          {% elif request.user|is_teacher %}
            <a href="#" class="nav-link">
              <span>Availability</span>
            </a>
          {% endif %}

        {% endif %}
      </div>
    </div>

    {# RIGHT: desktop actions (≥ sm) #}
    <div class="hidden sm:flex items-center gap-2 ml-auto">
      {% if request.user.is_authenticated %}
        {% if request.user|is_teacher %}
          {% url 'users:teacher_home' as profile_href %}
        {% elif request.user|is_admin %}
          {% url 'users:admin_home' as profile_href %}
        {% else %}
          {% url 'users:student_home' as profile_href %}
        {% endif %}
        <a
          href="{{ profile_href }}"
          class="focus-ring inline-flex items-center gap-2 text-sm hover:text-foreground/80 px-2 py-1.5 rounded-md"
        >
          {% icon 'verified_user' class_='h-5 w-5 align-middle shrink-0' %}
          <span>{{ request.user.get_short_name|default:request.user.email }}</span>
        </a>

        <form method="post" action="{% url 'users:logout' %}">
          {% csrf_token %}
          <button
            type="submit"
            class="focus-ring inline-flex items-center gap-2 justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors h-9 px-4 py-2 border border-border bg-background hover:bg-accent hover:text-accent-foreground"
          >
            {% icon 'logout' class_='h-5 w-5 align-middle shrink-0' %}
            <span>Logout</span>
          </button>
        </form>
      {% else %}
        <a
          href="{% url 'users:login' %}"
          class="focus-ring inline-flex items-center gap-2 justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors h-9 px-4 py-2 border border-border bg-background hover:bg-accent hover:text-accent-foreground {% active_url 'users:login' %}"
          {% aria_current 'users:login' %}
        >
          {% icon 'login' class_='h-5 w-5 align-middle shrink-0' %}
          <span>Login</span>
        </a>
      {% endif %}

      {% include "core/partials/theme_toggle.html" with variant="desktop" %}
    </div>

    {# MOBILE: toggle button #}
    <button
      type="button"
      class="focus-ring sm:hidden inline-flex items-center rounded-md border border-border bg-background p-2 text-sm shadow-sm hover:bg-accent hover:text-accent-foreground"
      @click="open = !open"
      :aria-expanded="open.toString()"
      aria-controls="mobile-menu"
    >
      <span class="sr-only">Toggle navigation</span>
      {% icon 'menu' class_='h-5 w-5' label='Toggle navigation' %}
    </button>

  </div>

  {# MOBILE PANEL (< sm) — uses active_url/aria_current instead of resolver_match #}
  <div
    id="mobile-menu"
    class="sm:hidden border-t border-border bg-background transition-standard"
    x-cloak
    x-show="open"
    x-transition:enter-start="opacity-0 -translate-y-2"
    x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave-start="opacity-100 translate-y-0"
    x-transition:leave-end="opacity-0 -translate-y-2"
    @keydown.escape.window="open = false"
    @click.outside="open = false"
    role="menu"
    :aria-hidden="(!open).toString()"
  >

    {# Home #}
    <a
      href="{% url 'core:landing' %}"
      class="nav-link focus-ring flex w-full rounded-md px-3 py-2 hover:bg-accent hover:text-accent-foreground {% active_url 'core:landing' %}"
      {% aria_current 'core:landing' %}
      @click="open = false"
      role="menuitem"
    >
      {% icon 'home' class_='h-5 w-5 align-middle shrink-0' %}
      <span>Home</span>
    </a>

    {# About (treat /about/* as active) #}
    <a
      href="{% url 'core:about' %}"
      class="nav-link focus-ring flex w-full rounded-md px-3 py-2 hover:bg-accent hover:text-accent-foreground {% active_url 'core:about' startswith='/about/' %}"
      {% aria_current 'core:about' startswith='/about/' %}
      @click="open = false"
      role="menuitem"
    >
      {% icon 'info' class_='h-5 w-5 align-middle shrink-0' %}
      <span>About</span>
    </a>

    {% if request.user.is_authenticated %}

      {# Dashboard (role-aware href) #}
      {% aria_current 'users:student_home' 'users:teacher_home' 'users:admin_home' as current_attr %}
      <a
        {% if request.user|is_teacher %}
          href="{% url 'users:teacher_home' %}"
        {% elif request.user|is_admin %}
          href="{% url 'users:admin_home' %}"
        {% else %}
          href="{% url 'users:student_home' %}"
        {% endif %}
        class="nav-link focus-ring flex w-full rounded-md px-3 py-2 hover:bg-accent hover:text-accent-foreground {% active_url 'users:student_home' 'users:teacher_home' 'users:admin_home' %}"
        {{ current_attr }}
        @click="open = false"
        role="menuitem"
      >
        {% icon 'dashboard' class_='h-5 w-5 align-middle shrink-0' %}
        <span>Dashboard</span>
      </a>

      {# Django admin (staff) #}
      {% if request.user.is_staff %}
        <a
          href="/admin/"
          class="nav-link focus-ring flex w-full rounded-md px-3 py-2 hover:bg-accent hover:text-accent-foreground {% active_url startswith='/admin/' %}"
          {% aria_current startswith='/admin/' %}
          @click="open = false"
          role="menuitem"
        >
          {% icon 'admin' class_='h-5 w-5 align-middle shrink-0' %}
          <span>Admin</span>
        </a>
      {% endif %}

      {# Register (admin role only) #}
      {% if request.user|is_admin %}
        <a
          href="{% url 'users:register' %}"
          class="nav-link focus-ring flex w-full rounded-md px-3 py-2 hover:bg-accent hover:text-accent-foreground {% active_url 'users:register' startswith='/users/register' %}"
          {% aria_current 'users:register' startswith='/users/register' %}
          @click="open = false"
          role="menuitem"
        >
          {% icon 'user_plus' class_='h-5 w-5 align-middle shrink-0' %}
          <span>Register</span>
        </a>
      {% endif %}

      {# Optional role placeholders #}
      {% if request.user|is_student %}
        <a
          href="#"
          class="nav-link focus-ring flex w-full rounded-md px-3 py-2 hover:bg-accent hover:text-accent-foreground"
          @click="open = false"
          role="menuitem"
        >
          {% icon 'school' class_='h-5 w-5 align-middle shrink-0' %}
          <span>Courses</span>
        </a>
      {% elif request.user|is_teacher %}
        <a
          href="#"
          class="nav-link focus-ring flex w-full rounded-md px-3 py-2 hover:bg-accent hover:text-accent-foreground"
          @click="open = false"
          role="menuitem"
        >
          <span>Availability</span>
        </a>
      {% endif %}

      <div class="py-1">
        {% include "core/partials/theme_toggle.html" with variant="mobile" %}
      </div>

      <form method="post" action="{% url 'users:logout' %}" class="mt-1 px-3 py-2">
        {% csrf_token %}
        <button
          type="submit"
          class="focus-ring flex w-full items-center gap-2 justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors h-9 px-4 py-2 border border-border bg-background hover:bg-accent hover:text-accent-foreground"
          @click="open = false"
        >
          {% icon 'logout' class_='h-5 w-5 align-middle shrink-0' %}
          <span>Logout</span>
        </button>
      </form>

    {% else %}

      <div class="px-3 py-2">
        {% include "core/partials/theme_toggle.html" with variant="mobile" %}
      </div>

      <a
        href="{% url 'users:login' %}"
        class="focus-ring nav-link flex w-full rounded-md px-3 py-2 hover:bg-accent hover:text-accent-foreground {% active_url 'users:login' %}"
        {% aria_current 'users:login' %}
        @click="open = false"
        role="menuitem"
      >
        {% icon 'login' class_='h-5 w-5 align-middle shrink-0' %}
        <span>Login</span>
      </a>

    {% endif %}
  </div>
</nav>
